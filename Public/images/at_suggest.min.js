$(function() {
    var k = null,
    f = null,
    j = 0,
    m = function(a, c, b) {
        var f = a.value.substring(c, a.value.length).replace(/^\x20/, ""),
        c = a.value.substring(0, c).replace(/@[^\s]*$/, "@");
        a.value = c + b + f
    },
    n = function(a, c, b) {
        c = a.value.substring(0, c).replace(/@[^\s]*$/, "@").length;
        if (a.createTextRange) {
            if ($.browser.opera && 9.5 <= $.browser.version && 0 == b) return ! 1;
            range = a.createTextRange();
            range.collapse(!0);
            range.moveStart("character", c + b);
            range.moveEnd("character", 0);
            range.select()
        } else a.setSelectionRange && a.setSelectionRange(c + b, c + b);
        a.focus()
    };
    $("body").bind("click",
    function() {
        $("#J_TextareaAtSuggest").hide()
    });
    $("textarea.atsug").live("mousedown keydown",
    function(a) {
        k = $(this);
        f = this;
        a = a || window.event;
        a.stopPropagation ? a.stopPropagation() : a.cancelBubble = !0;
        var c = "";
        if ($("#J_TextareaAtSuggest:visible").length) {
            if (13 == a.keyCode) return a = $("#J_TextareaAtSuggest li.cur a").text(),
            m(f, j, a + " "),
            n(f, j, a.length + 1),
            $("#J_TextareaAtSuggest").hide(),
            !1;
            var b = $("#J_TextareaAtSuggest li.cur"),
            h = $("#J_TextareaAtSuggest li");
            if (38 == a.keyCode) {
                if (2 == h.length) return ! 1;
                1 == b.prev(":not(.suggest_title)").length ? (b.removeClass("cur"), b.prev().addClass("cur")) : (b.removeClass("cur"), h.last().addClass("cur"));
                return ! 1
            }
            if (40 == a.keyCode) {
                if (2 == h.length) return ! 1;
                1 == b.next().length ? (b.removeClass("cur"), b.next().addClass("cur")) : (b.removeClass("cur"), h.eq(1).addClass("cur"));
                return ! 1
            }
        }
        setTimeout(function() {
            var a = f.value,
            b = 1;
            if (a.length && -1 == a.indexOf("@")) $("#J_TextareaAtSuggest").hide();
            else {
                var i = f;
                i.focus();
                var g = 0;
                if (document.selection) if (document.selection.createRange(), $.browser.msie) {
                    var h = document.selection.createRange(),
                    l = h.duplicate();
                    l.moveToElementText(i);
                    for (g = -1; l.inRange(h);) l.moveStart("character"),
                    g++
                } else g = i.selectionStart;
                else g = i.selectionStart,
                i.value.substring(g, i.selectionEnd);
                if (j = g) if (a = a.substring(0, j), /@[^\s]*$/gm.test(a)) if (a = a.replace(/\r\n/gm,
                function() {
                    b++;
                    return " [br]"
                }), a = a.replace(/\r/gm,
                function() {
                    b++;
                    return " [br]"
                }), a = a.replace(/\n/gm,
                function() {
                    b++;
                    return " [br]"
                }), a = a.split(" [br]").pop(), /@[^\s]*$/g.test(a)) { / \@$ / g.test(a) || (c = a.split("@").pop());
                    var o = a,
                    p = b;
                    $.ajax({
                        url: GUANGER.path + "/user/at/suggest",
                        type: "post",
                        dataType: "json",
                        data: {
                            keywords: c
                        },
                        success: function(a) {
                            if (100 == a.code) {
                                var a = a.userMiniVOList,
                                b = "",
                                d;
                                d = $(f);
                                var e = parseInt(d.css("padding-left"), 10),
                                c = parseInt(d.css("padding-top"), 10),
                                h = parseInt(d.css("line-height"), 10),
                                i = parseInt(d.scrollTop(), 10),
                                g = o.replace(/@[^\s]*$/, "");
                                g.length && (0 === $("#J_TestTextPxLength").length ? ($("body").append('<div id="J_TestTextPxLength" style="position:absolute;top:0;left:0;">' + g + "</div>"), $("#J_TestTextPxLength").css("font-size", d.css("font-size"))) : $("#J_TestTextPxLength").html(g), e += $("#J_TestTextPxLength").width());
                                c = c + h * p - i;
                                d = {
                                    left: e,
                                    top: c
                                };
                                d = {
                                    top: d.top + k.offset().top + 5,
                                    left: d.left + k.offset().left
                                };
                                if ($("#J_TextareaAtSuggest").length) {
                                    b += '<li class="suggest_title">\u9009\u62e9\u6700\u8fd1@\u7684\u4eba\u6216\u76f4\u63a5\u8f93\u5165</li>';
                                    for (e = 0; e < a.length; e++) b = 0 == e ? b + ('<li class="cur"><a rel="setSuggest" href="javascript:;">' + a[e].name + "</a></li>") : b + ('<li><a unselectable="on" rel="setSuggest" href="javascript:;">' + a[e].name + "</a></li>");
                                    $("#J_TextareaAtSuggest").css({
                                        top: d.top,
                                        left: d.left
                                    });
                                    $("#J_TextareaAtSuggest ul").html(b);
                                    $("#J_TextareaAtSuggest").show()
                                } else {
                                    b = '<div id="J_TextareaAtSuggest" style="top:' + d.top + "px;left:" + d.left + ';"><ul><li class="suggest_title">\u9009\u62e9\u6700\u8fd1@\u7684\u4eba\u6216\u76f4\u63a5\u8f93\u5165</li>';
                                    for (e = 0; e < a.length; e++) b = 0 == e ? b + ('<li class="cur"><a unselectable="on" rel="setSuggest" href="javascript:;">' + a[e].name + "</a></li>") : b + ('<li><a unselectable="on" rel="setSuggest" href="javascript:;">' + a[e].name + "</a></li>");
                                    $("body").append(b + "</ul></div>");
                                    $("#J_TextareaAtSuggest").css({
                                        top: d.top,
                                        left: d.left
                                    })
                                }
                                $("a[rel=setSuggest]").unbind().hover(function() {
                                    $(this).parent().addClass("cur")
                                },
                                function() {
                                    $(this).parent().removeClass("cur")
                                });
                                $("#J_TextareaAtSuggest").unbind().click(function(a) {
                                    var a = a || window.event,
                                    b = a.srcElement ? $(a.srcElement) : $(a.target);
                                    if (b.attr("rel") == "setSuggest") {
                                        a = b.text();
                                        m(f, j, a + " ");
                                        n(f, j, a.length + 1)
                                    } else a.stopPropagation ? a.stopPropagation() : a.cancelBubble = true
                                })
                            } else $("#J_TextareaAtSuggest").hide()
                        }
                    })
                } else $("#J_TextareaAtSuggest").hide();
                else $("#J_TextareaAtSuggest").hide();
                else $("#J_TextareaAtSuggest").hide()
            }
        },
        100)
    })
});